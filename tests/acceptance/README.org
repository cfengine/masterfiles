* Writing tests against the stdlib

The test framework for masterfiles piggy backs on the test framework from core.
It's important to note =plucked.cf.sub= comes from the core repository and that
it includes bodies and bundles from the stdlib which are useful in writing tests
in core. This presents a problem for writing tests in the masterfiles framework
because =plucked.cf.sub= is included and simply including the stdlib could
result in duplicate definition of bundle errors.

To work around this complication you can create a subtest that includes the
stdlib directly, but does not include the rest of the test framework.

** Example test

This is the main test. Note how it includes =default.cf.sub= and runs the
typical test bundlesequence. The test passes based on the *OUTPUT* of the
subtest which runs from a policy file with the same name suffixed with =.sub=.

#+Name: lib/reports/head.cf
#+BEGIN_SRC cfengine3
body common control
{
        inputs => { '../../default.cf.sub' };
        bundlesequence  => { default("$(this.promise_filename)") };
        version => "1.0";
}

bundle agent test
{
  meta:
      "description" string => "
Test that body printfile head works as expected";

}
bundle agent check
{
  vars:
      "pass_reg" string => ".*R: My first line
R: line 0
R: line 1
R: line 2
R: line 3
R: line 4
R: line 5
R: line 6
R: line 7
R: line 8
R: line 9";

      "command" string => "$(sys.cf_agent) -K -f $(this.promise_filename).sub";

  methods:
      "" usebundle => dcs_passif_output("$(pass_reg)", "", $(command), $(this.promise_filename));
}
#+END_SRC

This is the subtest itself. Note how it *does not include the test framework*
(=default.cf.sub=) but instead includes the part of the standard library that it
needs for the test. In this case the subtest outputs information that the main
test inspects for pass or failure. The main test could also inspect data in
other files. Consider writing a data file containing the =datastate()= or
=bundlestate()= of the subtest and having the main test use that to determine
pass or failure.

#+Name: lib/reports/head.cf.sub
#+BEGIN_SRC cfengine3
body file control
{
      # Include the stdlib directly so that we are always testing the most
      # recent version
        inputs => { '../../../../lib/reports.cf' };
}

bundle agent main
{
  reports:
    "My first line"
      printfile => head( "$(this.promise_dirname)/printfile.txt");
}
#+END_SRC

#+Name: Example Test Run
#+BEGIN_EXAMPLE
> $ ./testall --printlog ./lib/reports/head.cf
======================================================================
Testsuite started at 2016-04-06 08:31:05
----------------------------------------------------------------------
Total tests: 1

CRASHING_TESTS: enabled
NETWORK_TESTS: enabled
STAGING_TESTS: disabled
UNSAFE_TESTS: disabled
LIBXML2_TESTS: enabled

./lib/reports/head.cf Pass

======================================================================
Testsuite finished at 2016-04-06 08:31:06 (1 seconds)

Passed tests:  1
Failed tests:  0
Skipped tests: 0
Soft failures: 0
Total tests:   1
======================================================================
Testsuite started at 2016-04-06 08:31:05
----------------------------------------------------------------------
Total tests: 1

CRASHING_TESTS: enabled
NETWORK_TESTS: enabled
STAGING_TESTS: disabled
UNSAFE_TESTS: disabled
LIBXML2_TESTS: enabled

----------------------------------------------------------------------
./lib/reports/head.cf
----------------------------------------------------------------------
/home/nickanderson/CFEngine/core/cf-agent/.libs/lt-cf-agent: /var/cfengine/lib/libssl.so.1.0.0: no version information available (required by /home/nickanderson/CFEngine/core/libpromises/.libs/libpromises.so.3)
/home/nickanderson/CFEngine/core/cf-agent/.libs/lt-cf-agent: /var/cfengine/lib/libcrypto.so.1.0.0: no version information available (required by /home/nickanderson/CFEngine/core/libpromises/.libs/libpromises.so.3)
   error: UNTRUSTED: Module directory /home/nickanderson/CFEngine/masterfiles/tests/acceptance/workdir/__lib_reports_head_cf/modules (mode 775) was not private!
/home/nickanderson/CFEngine/core/cf-promises/.libs/lt-cf-promises: /var/cfengine/lib/libssl.so.1.0.0: no version information available (required by /home/nickanderson/CFEngine/core/libpromises/.libs/libpromises.so.3)
/home/nickanderson/CFEngine/core/cf-promises/.libs/lt-cf-promises: /var/cfengine/lib/libcrypto.so.1.0.0: no version information available (required by /home/nickanderson/CFEngine/core/libpromises/.libs/libpromises.so.3)
   error: UNTRUSTED: Module directory /home/nickanderson/CFEngine/masterfiles/tests/acceptance/workdir/__lib_reports_head_cf/modules (mode 775) was not private!
R: test description:
Test that body printfile head works as expected
R: /home/nickanderson/CFEngine/masterfiles/tests/acceptance/./lib/reports/head.cf Pass
R: dcs_passif_output: the output of command '"/home/nickanderson/CFEngine/masterfiles/tests/acceptance/workdir/__lib_reports_head_cf/bin/cf-agent" -K -f /home/nickanderson/CFEngine/masterfiles/tests/acceptance/./lib/reports/head.cf.sub' was: '/home/nickanderson/CFEngine/core/cf-agent/.libs/lt-cf-agent: /var/cfengine/lib/libssl.so.1.0.0: no version information available (required by /home/nickanderson/CFEngine/core/libpromises/.libs/libpromises.so.3)
/home/nickanderson/CFEngine/core/cf-agent/.libs/lt-cf-agent: /var/cfengine/lib/libcrypto.so.1.0.0: no version information available (required by /home/nickanderson/CFEngine/core/libpromises/.libs/libpromises.so.3)
   error: UNTRUSTED: Module directory /home/nickanderson/CFEngine/masterfiles/tests/acceptance/workdir/__lib_reports_head_cf/modules (mode 775) was not private!
/home/nickanderson/CFEngine/core/cf-promises/.libs/lt-cf-promises: /var/cfengine/lib/libssl.so.1.0.0: no version information available (required by /home/nickanderson/CFEngine/core/libpromises/.libs/libpromises.so.3)
/home/nickanderson/CFEngine/core/cf-promises/.libs/lt-cf-promises: /var/cfengine/lib/libcrypto.so.1.0.0: no version information available (required by /home/nickanderson/CFEngine/core/libpromises/.libs/libpromises.so.3)
   error: UNTRUSTED: Module directory /home/nickanderson/CFEngine/masterfiles/tests/acceptance/workdir/__lib_reports_head_cf/modules (mode 775) was not private!
R: My first line
R: line 0
R: line 1
R: line 2
R: line 3
R: line 4
R: line 5
R: line 6
R: line 7
R: line 8
R: line 9'

Return code is 0.

  ==> Pass


======================================================================
Testsuite finished at 2016-04-06 08:31:06 (1 seconds)

Passed tests:  1
Failed tests:  0
Skipped tests: 0
Soft failures: 0
Total tests:   1
#+END_EXAMPLE

** Check test

#+NAME: run-test
#+CAPTION: Running a test manually
#+begin_src sh :results output :exports both :var TESTFILE="./lib/files/edit_line_converge.cf"
  exec 2>&1
  find ../../lib/ -name "*.cf" | xargs chmod 600
  chmod 600 ${TESTFILE}
  ./testall \
      --bindir="/var/cfengine/bin/" \
      --printlog ${TESTFILE}
  :
#+end_src

#+CALL: run-test(TESTFILE="./lib/files/manage_variable_values_ini/promised_section_missing_at_start.cf")

#+RESULTS:
#+begin_example
======================================================================
Testsuite started at 2020-10-30 15:14:08
----------------------------------------------------------------------
Total tests: 1

        COMMON_TESTS: enabled
         TIMED_TESTS: enabled
          SLOW_TESTS: enabled
     ERROREXIT_TESTS: enabled
        SERIAL_TESTS: enabled
       NETWORK_TESTS: enabled
       LIBXML2_TESTS: enabled
       LIBCURL_TESTS: enabled
        UNSAFE_TESTS: disabled
       STAGING_TESTS: disabled

Test run is not parallel

./lib/files/manage_variable_values_ini/promised_section_missing_at_start.cf Soft fail (CFE-3428)

======================================================================
Testsuite finished at 2020-10-30 15:14:08 (0 seconds)

Passed tests:  0
Failed tests:  0
Skipped tests: 0
Soft failures: 1
Total tests:   1
======================================================================
Testsuite started at 2020-10-30 15:14:08
----------------------------------------------------------------------
Total tests: 1

        COMMON_TESTS: enabled
         TIMED_TESTS: enabled
          SLOW_TESTS: enabled
     ERROREXIT_TESTS: enabled
        SERIAL_TESTS: enabled
       NETWORK_TESTS: enabled
       LIBXML2_TESTS: enabled
       LIBCURL_TESTS: enabled
        UNSAFE_TESTS: disabled
       STAGING_TESTS: disabled

Test run is not parallel

----------------------------------------------------------------------
./lib/files/manage_variable_values_ini/promised_section_missing_at_start.cf
----------------------------------------------------------------------
2020-10-30T15:14:08-0500    error: UNTRUSTED: Module directory /home/nickanderson/Northern.Tech/CFEngine/masterfiles/tests/acceptance/workdir/__lib_files_manage_variable_values_ini_promised_section_missing_at_start_cf/modules (mode 775) was not private!
   error: UNTRUSTED: Module directory /home/nickanderson/Northern.Tech/CFEngine/masterfiles/tests/acceptance/workdir/__lib_files_manage_variable_values_ini_promised_section_missing_at_start_cf/modules (mode 775) was not private!
R: test description: Test expected behavior of manage_variable_values_ini when the
                   promised section does not exist to begin with. When the
                   section does not exist, it should be inserted at the top of
                   the file with all of the proper content in the section.
R: /home/nickanderson/Northern.Tech/CFEngine/masterfiles/tests/acceptance/./lib/files/manage_variable_values_ini/../../../dcs.cf.sub SFAIL/CFE-3428
2020-10-30T15:14:08-0500    error: The promised line deletion '.*' could not select an edit region in '/home/nickanderson/Northern.Tech/CFEngine/masterfiles/tests/acceptance/workdir/__lib_files_manage_variable_values_ini_promised_section_missing_at_start_cf/tmp/TEST.cfengine' (but the delimiters were expected in the file)
2020-10-30T15:14:08-0500    error: The promised line insertion 'keepme=Should be only key in CFE-3428 when finished.' could not select an edit region in '/home/nickanderson/Northern.Tech/CFEngine/masterfiles/tests/acceptance/workdir/__lib_files_manage_variable_values_ini_promised_section_missing_at_start_cf/tmp/TEST.cfengine'
2020-10-30T15:14:08-0500    error: The promised line deletion '.*' could not select an edit region in '/home/nickanderson/Northern.Tech/CFEngine/masterfiles/tests/acceptance/workdir/__lib_files_manage_variable_values_ini_promised_section_missing_at_start_cf/tmp/TEST.cfengine' (but the delimiters were expected in the file)
2020-10-30T15:14:08-0500    error: The promised line insertion 'keepme=Should be only key in CFE-3428 when finished.' could not select an edit region in '/home/nickanderson/Northern.Tech/CFEngine/masterfiles/tests/acceptance/workdir/__lib_files_manage_variable_values_ini_promised_section_missing_at_start_cf/tmp/TEST.cfengine'
2020-10-30T15:14:08-0500    error: The promised line deletion '.*' could not select an edit region in '/home/nickanderson/Northern.Tech/CFEngine/masterfiles/tests/acceptance/workdir/__lib_files_manage_variable_values_ini_promised_section_missing_at_start_cf/tmp/TEST.cfengine' (but the delimiters were expected in the file)
2020-10-30T15:14:08-0500    error: The promised line insertion 'keepme=Should be only key in CFE-3428 when finished.' could not select an edit region in '/home/nickanderson/Northern.Tech/CFEngine/masterfiles/tests/acceptance/workdir/__lib_files_manage_variable_values_ini_promised_section_missing_at_start_cf/tmp/TEST.cfengine'
R: FILES DIFFER BUT SHOULD BE THE SAME
R: CONTENTS OF /home/nickanderson/Northern.Tech/CFEngine/masterfiles/tests/acceptance/workdir/__lib_files_manage_variable_values_ini_promised_section_missing_at_start_cf/tmp/TEST.cfengine:
[section]
keyone=1
keytwo=valuetwo
[should_remain_unchanged]
wat=WUT
[CFE-3428]

R: CONTENTS OF /home/nickanderson/Northern.Tech/CFEngine/masterfiles/tests/acceptance/./lib/files/manage_variable_values_ini/promised_section_missing_at_start.cf.expected_when_finished:
[CFE-3428]
keepme=Should be only key in CFE-3428 when finished.
[section]
keyone=1
keytwo=valuetwo
[should_remain_unchanged]
wat=WUT
R: *** /home/nickanderson/Northern.Tech/CFEngine/masterfiles/tests/acceptance/./lib/files/manage_variable_values_ini/promised_section_missing_at_start.cf.expected_when_finished	Fri Oct 30 15:00:20 2020
--- /home/nickanderson/Northern.Tech/CFEngine/masterfiles/tests/acceptance/workdir/__lib_files_manage_variable_values_ini_promised_section_missing_at_start_cf/tmp/TEST.cfengine	Fri Oct 30 15:14:08 2020
,***************
,*** 1,7 ****
- [CFE-3428]
- keepme=Should be only key in CFE-3428 when finished.
  [section]
  keyone=1
  keytwo=valuetwo
  [should_remain_unchanged]
! wat=WUT
\ No newline at end of file
--- 1,6 ----
  [section]
  keyone=1
  keytwo=valuetwo
  [should_remain_unchanged]
! wat=WUT
! [CFE-3428]
R: hexdump /home/nickanderson/Northern.Tech/CFEngine/masterfiles/tests/acceptance/workdir/__lib_files_manage_variable_values_ini_promised_section_missing_at_start_cf/tmp/TEST.cfengine:
00000000  5b 73 65 63 74 69 6f 6e  5d 0a 6b 65 79 6f 6e 65  |[section].keyone|
00000010  3d 31 0a 6b 65 79 74 77  6f 3d 76 61 6c 75 65 74  |=1.keytwo=valuet|
00000020  77 6f 0a 5b 73 68 6f 75  6c 64 5f 72 65 6d 61 69  |wo.[should_remai|
00000030  6e 5f 75 6e 63 68 61 6e  67 65 64 5d 0a 77 61 74  |n_unchanged].wat|
00000040  3d 57 55 54 0a 5b 43 46  45 2d 33 34 32 38 5d 0a  |=WUT.[CFE-3428].|
00000050
R: hexdump /home/nickanderson/Northern.Tech/CFEngine/masterfiles/tests/acceptance/./lib/files/manage_variable_values_ini/promised_section_missing_at_start.cf.expected_when_finished:
00000000  5b 43 46 45 2d 33 34 32  38 5d 0a 6b 65 65 70 6d  |[CFE-3428].keepm|
00000010  65 3d 53 68 6f 75 6c 64  20 62 65 20 6f 6e 6c 79  |e=Should be only|
00000020  20 6b 65 79 20 69 6e 20  43 46 45 2d 33 34 32 38  | key in CFE-3428|
00000030  20 77 68 65 6e 20 66 69  6e 69 73 68 65 64 2e 0a  | when finished..|
00000040  5b 73 65 63 74 69 6f 6e  5d 0a 6b 65 79 6f 6e 65  |[section].keyone|
00000050  3d 31 0a 6b 65 79 74 77  6f 3d 76 61 6c 75 65 74  |=1.keytwo=valuet|
00000060  77 6f 0a 5b 73 68 6f 75  6c 64 5f 72 65 6d 61 69  |wo.[should_remai|
00000070  6e 5f 75 6e 63 68 61 6e  67 65 64 5d 0a 77 61 74  |n_unchanged].wat|
00000080  3d 57 55 54                                       |=WUT|
00000084
R: Diff command: /usr/bin/diff -u /home/nickanderson/Northern.Tech/CFEngine/masterfiles/tests/acceptance/./lib/files/manage_variable_values_ini/promised_section_missing_at_start.cf.expected_when_finished /home/nickanderson/Northern.Tech/CFEngine/masterfiles/tests/acceptance/workdir/__lib_files_manage_variable_values_ini_promised_section_missing_at_start_cf/tmp/TEST.cfengine 2>/dev/null
R: /home/nickanderson/Northern.Tech/CFEngine/masterfiles/tests/acceptance/./lib/files/manage_variable_values_ini/promised_section_missing_at_start.cf FAIL

Return code is 0.

  ==> Soft fail (CFE-3428)


======================================================================
Testsuite finished at 2020-10-30 15:14:08 (0 seconds)

Passed tests:  0
Failed tests:  0
Skipped tests: 0
Soft failures: 1
Total tests:   1
#+end_example
